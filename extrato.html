<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="color-scheme" content="light">
    <title>McDonald's Elite - Extrato Premium</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;900&display=swap" rel="stylesheet">

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
      import { getFirestore, collection, query, where, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyALPWsneYLrR8R6d7KlYwHcfgcWqoxha8Y",
        authDomain: "mac09875.firebaseapp.com",
        projectId: "mac09875",
        storageBucket: "mac09875.firebasestorage.app",
        messagingSenderId: "1036489448526",
        appId: "1:1036489448526:web:aa40d000e12f21a6b0771f"
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      let allTransactions = [];

      onAuthStateChanged(auth, async (user) => {
          if (user) {
              await loadStatement(user.uid);
          } else {
              window.location.href = "index.html";
          }
      });

      async function loadStatement(uid) {
          const container = document.getElementById('statementList');
          const emptyState = document.getElementById('emptyState');

          try {
              // Busca no histórico vinculado ao UID do usuário logado
              const q = query(
                  collection(db, "historico"), 
                  where("userId", "==", uid)
              );
              
              const querySnapshot = await getDocs(q);

              if (querySnapshot.empty) {
                  emptyState.style.display = 'block';
                  return;
              }

              emptyState.style.display = 'none';
              allTransactions = [];

              querySnapshot.forEach(doc => {
                  allTransactions.push({
                      id: doc.id,
                      ...doc.data()
                  });
              });
              
              // Ordenação manual por data (caso o índice do Firestore não esteja pronto)
              allTransactions.sort((a, b) => {
                  const dateA = new Date(a.data || 0);
                  const dateB = new Date(b.data || 0);
                  return dateB - dateA;
              });

              renderTransactions(allTransactions);

          } catch (error) {
              console.error("Erro ao carregar extrato:", error);
              // Fallback para exibir erro na tela se necessário
          }
      }

      function renderTransactions(filterList) {
          const container = document.getElementById('statementList');
          container.innerHTML = '';

          if (filterList.length === 0) {
              document.getElementById('emptyState').style.display = 'block';
              return;
          }

          document.getElementById('emptyState').style.display = 'none';

          filterList.forEach((data) => {
              const card = document.createElement('div');
              card.className = `transaction-card ${data.tipo}`;

              let icon, label, symbol, isNegative = false;
              
              // Lógica de Identificação de Fluxo (+ ou -) e Ícones
              switch(data.tipo) {
                  case 'deposito':
                      icon = 'fa-arrow-down-long';
                      label = 'Recarga Via Pix';
                      symbol = '+';
                      isNegative = false;
                      break;
                  case 'saque':
                      icon = 'fa-paper-plane';
                      label = 'Retirada de Saldo';
                      symbol = '-';
                      isNegative = true;
                      break;
                  case 'lucro':
                      icon = 'fa-chart-line';
                      label = 'Rendimento Diário';
                      symbol = '+';
                      isNegative = false;
                      break;
                  case 'comissao':
                      icon = 'fa-users';
                      label = 'Comissão de Rede';
                      symbol = '+';
                      isNegative = false;
                      break;
                  case 'compra':
                      icon = 'fa-cart-shopping';
                      label = 'Investimento M-Elite';
                      symbol = '-';
                      isNegative = true;
                      break;
                  case 'bonus':
                      icon = 'fa-gift';
                      label = 'Bônus Administrativo';
                      symbol = '+';
                      isNegative = false;
                      break;
                  default:
                      icon = 'fa-receipt';
                      label = 'Movimentação';
                      symbol = '';
              }

              // Formatação de data amigável
              const dataFormatada = data.data ? new Date(data.data).toLocaleString('pt-BR') : 'Data não disponível';

              card.innerHTML = `
                  <div class="trans-icon-wrapper">
                      <i class="fa-solid ${icon}"></i>
                  </div>
                  <div class="trans-details">
                      <span class="trans-name">${label}</span>
                      <span class="trans-date">${dataFormatada}</span>
                  </div>
                  <div class="trans-value ${isNegative ? 'negative' : 'positive'}">
                      <span class="symbol">${symbol}</span> R$ ${parseFloat(data.valor || 0).toFixed(2).replace('.', ',')}
                  </div>
              `;
              container.appendChild(card);
          });
      }

      // Sistema de Filtro por Chips
      window.filterByType = function(type, element) {
          document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
          element.classList.add('active');

          if (type === 'todos') {
              renderTransactions(allTransactions);
          } else {
              const filtered = allTransactions.filter(t => t.tipo === type);
              renderTransactions(filtered);
          }
      }
    </script>

    <style>
        :root {
            --mcd-red: #db0007;
            --mcd-gold: #ffbc0d;
            --pure-white: #ffffff;
            --bg-light: #f5f5f7;
            --text-dark: #1d1d1f;
            --success: #27ae60;
            --error: #eb4d4b;
            --info: #2980b9;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Montserrat', sans-serif; -webkit-tap-highlight-color: transparent; }

        body { background-color: var(--bg-light); color: var(--text-dark); min-height: 100vh; padding-bottom: 50px; }

        /* Header Estilizado */
        .header-premium {
            background: linear-gradient(135deg, var(--mcd-red) 0%, #a50005 100%);
            height: 180px;
            padding: 40px 25px;
            border-bottom-left-radius: 40px;
            border-bottom-right-radius: 40px;
            color: white;
            text-align: center;
            position: relative;
        }

        .back-link {
            position: absolute; left: 20px; top: 40px; width: 45px; height: 45px;
            background: rgba(255,255,255,0.2); border-radius: 15px;
            display: flex; align-items: center; justify-content: center; color: white; text-decoration: none;
            transition: 0.3s;
        }
        .back-link:active { transform: scale(0.9); background: rgba(255,255,255,0.3); }

        .header-premium h2 { font-weight: 900; font-size: 22px; letter-spacing: 1px; margin-top: 5px; }
        .header-premium p { font-size: 11px; font-weight: 700; opacity: 0.8; text-transform: uppercase; }

        /* Filtros de Navegação Rápida */
        .filter-container {
            display: flex; gap: 10px; padding: 0 20px; overflow-x: auto;
            margin-top: -65px; margin-bottom: 25px; position: relative; z-index: 20;
            scrollbar-width: none;
        }
        .filter-container::-webkit-scrollbar { display: none; }

        .chip {
            padding: 12px 22px; background: white; border-radius: 50px;
            font-size: 11px; font-weight: 800; color: #888; border: 1px solid rgba(0,0,0,0.05);
            white-space: nowrap; box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            transition: 0.3s;
            cursor: pointer;
        }
        .chip.active { background: var(--mcd-gold); color: var(--text-dark); border-color: var(--mcd-gold); transform: translateY(-2px); }

        /* Lista de Transações */
        .content-area { width: 92%; margin: 0 auto; position: relative; z-index: 10; }

        .transaction-card {
            background: var(--pure-white); border-radius: 25px; padding: 18px;
            margin-bottom: 12px; display: flex; align-items: center; gap: 15px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.02); border: 1px solid rgba(255,255,255,0.8);
            animation: slideUp 0.4s ease-out forwards;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .trans-icon-wrapper {
            width: 50px; height: 50px; border-radius: 16px;
            display: flex; align-items: center; justify-content: center; font-size: 18px;
        }

        .trans-details { flex: 1; display: flex; flex-direction: column; }
        .trans-name { font-size: 13px; font-weight: 800; color: #333; }
        .trans-date { font-size: 10px; color: #aaa; font-weight: 700; margin-top: 2px; }

        .trans-value { font-size: 14px; font-weight: 900; white-space: nowrap; }
        .positive { color: var(--success); }
        .negative { color: var(--error); }

        /* Mapeamento de Cores por Tipo */
        .deposito .trans-icon-wrapper { background: #e6fff0; color: var(--success); }
        .saque .trans-icon-wrapper { background: #fff0f0; color: var(--error); }
        .lucro .trans-icon-wrapper { background: #fff9e6; color: var(--mcd-gold); }
        .comissao .trans-icon-wrapper { background: #eef2ff; color: var(--info); }
        .compra .trans-icon-wrapper { background: #f4f4f4; color: #555; }
        .bonus .trans-icon-wrapper { background: #fff0f6; color: #d63384; }

        /* Empty State */
        .empty-state { text-align: center; padding: 80px 20px; display: none; }
        .empty-state i { font-size: 50px; color: #ddd; margin-bottom: 15px; }
        .empty-state p { font-size: 13px; color: #999; font-weight: 600; }

    </style>
</head>
<body>

    <header class="header-premium">
        <a href="perfil.html" class="back-link"><i class="fa-solid fa-chevron-left"></i></a>
        <p>Histórico Financeiro</p>
        <h2>EXTRATO ELITE</h2>
    </header>

    <div class="filter-container">
        <div class="chip active" onclick="filterByType('todos', this)">Todos</div>
        <div class="chip" onclick="filterByType('deposito', this)">Recargas</div>
        <div class="chip" onclick="filterByType('compra', this)">Investimentos</div>
        <div class="chip" onclick="filterByType('lucro', this)">Rendimentos</div>
        <div class="chip" onclick="filterByType('saque', this)">Saques</div>
        <div class="chip" onclick="filterByType('comissao', this)">Comissões</div>
    </div>

    <main class="content-area">
        <div id="statementList">
            </div>

        <div id="emptyState" class="empty-state">
            <i class="fa-solid fa-receipt"></i>
            <p>Você ainda não possui movimentações financeiras em sua conta.</p>
        </div>
    </main>

</body>
</html>
